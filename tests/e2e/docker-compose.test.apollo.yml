services:
  test-runner:
    image: ghcr.io/c-daly/logos-foundry:0.1.0
    container_name: apollo-test-runner
    volumes:
      - ${APOLLO_ROOT:-./../..}:/app/apollo:ro
    working_dir: /app/apollo
    environment:
      NEO4J_URI: bolt://neo4j:27687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neo4jtest
      PYTHONPATH: /app:/app/apollo/src
    entrypoint: /bin/sh
    command: 
      - -c
      - |
        cd /app/apollo
        poetry install --no-root --only main
        pytest tests/ -m "not integration" -v --no-cov
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - default

  sophia-mock:
    build:
      context: ${PWD}/mocks/sophia
      dockerfile: Dockerfile
    container_name: apollo-test-sophia
    ports:
      - "28080:8080"
    environment:
      NEO4J_URI: bolt://neo4j:27687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: neo4jtest
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8080/health
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - default


# Apollo CLI Prototype Wiring

This document describes the prototype wiring between Apollo CLI and Sophia services.

## Overview

The Apollo CLI has been wired to communicate with Sophia cognitive core services through HTTP REST API calls. This prototype implementation provides the foundation for user interaction with the LOGOS system.

## Architecture

```
User → Apollo CLI → HTTP REST API → Sophia Service
                                   ↓
                                   HCG (Neo4j + Milvus)
```

## API Endpoints

The Apollo CLI connects to Sophia using the following endpoints:

### Health Check
- **Endpoint**: `GET /health`
- **Purpose**: Check if Sophia service is available
- **Used by**: `apollo-cli status` command

### Send Command
- **Endpoint**: `POST /api/command`
- **Payload**: `{"command": "<natural language command>"}`
- **Purpose**: Send natural language commands to Sophia
- **Used by**: `apollo-cli send "<command>"` command

### Get State
- **Endpoint**: `GET /api/state`
- **Purpose**: Retrieve current agent state from Sophia
- **Used by**: `apollo-cli state` command

### Get Plans
- **Endpoint**: `GET /api/plans?limit=<n>`
- **Purpose**: Retrieve recent plans generated by Sophia
- **Used by**: `apollo-cli plans --recent <n>` command

### Invoke Planner (Phase 1)
- **Endpoint**: `POST /api/planner/invoke`
- **Payload**: `{"goal_id": "<goal_id>"}`
- **Purpose**: Invoke planner to generate a plan for a specific goal
- **Used by**: `apollo-cli plan "<goal_id>"` command
- **Phase 1**: This may be a stub/shim that returns a simulated plan

### Execute Plan Step (Phase 1)
- **Endpoint**: `POST /api/executor/step`
- **Payload**: `{"plan_id": "<plan_id>", "step_index": <index>}`
- **Purpose**: Execute a single step from a plan (simulated in Phase 1)
- **Used by**: `apollo-cli execute "<plan_id>" --step <index>` command
- **Phase 1**: This may be a stub/shim that simulates execution via Talos

## Configuration

Apollo uses a hierarchical configuration system with defaults suitable for local Docker Compose deployments:

### Default Configuration
```yaml
sophia:
  host: localhost
  port: 8080
  timeout: 30
```

### Configuration Priority
1. Config file specified via `--config` flag
2. `config.yaml` in current directory
3. `config.yml` in current directory
4. `~/.apollo/config.yaml` in user home directory
5. Built-in defaults

## CLI Commands

### Status
```bash
apollo-cli status
```
Displays connection configuration and checks if Sophia is accessible.

### Send Command
```bash
apollo-cli send "pick up the red block"
```
Sends a natural language command to Sophia and displays the response.

### State
```bash
apollo-cli state
```
Retrieves and displays the current agent state from Sophia.

### Plans
```bash
apollo-cli plans --recent 10
```
Retrieves and displays recent plans generated by Sophia (default: 10 plans).

### Goal
```bash
apollo-cli goal "Navigate to the kitchen" --priority high
```
Creates a new goal in Sophia with optional priority.

### Plan (Phase 1)
```bash
apollo-cli plan "goal_12345"
```
Invokes the planner to generate a plan for a specific goal ID.

### Execute (Phase 1)
```bash
apollo-cli execute "plan_456" --step 0
```
Executes a single step from a plan (simulated execution in Phase 1).

## Phase 1 Loop

The Phase 1 prototype implements the complete goal→plan→execute→state loop:

1. **Create Goal**: `apollo-cli goal "Navigate to kitchen"`
2. **Invoke Planner**: `apollo-cli plan <goal_id>`
3. **Execute Step**: `apollo-cli execute <plan_id> --step 0`
4. **Check State**: `apollo-cli state`

This loop can be verified end-to-end using the M4 test script in `PHASE1_VERIFY/scripts/m4_test.py`.

## Output Formatting

Apollo CLI uses Rich library for formatted terminal output:

- **YAML Syntax Highlighting**: State and response data displayed with color-coded YAML
- **Panels**: Important information displayed in bordered panels
- **Tables**: Plans displayed in structured tables with columns
- **Status Icons**: ✓ for success, ✗ for errors
- **Color Coding**: Green for success, red for errors, yellow for warnings

## Error Handling

The client implements comprehensive error handling:

- **Connection Errors**: Clear message when Sophia is not accessible
- **Timeout Errors**: Notification when requests exceed timeout threshold
- **HTTP Errors**: Proper handling of HTTP status codes
- **Generic Errors**: Catch-all for unexpected errors

All errors include helpful tips for troubleshooting.

## Testing

Tests verify:
- Client initialization with custom configuration
- Connection error handling when service is unavailable
- Response structure and error messages
- Configuration loading and defaults

Run tests with:
```bash
pytest tests/
```

## Local Development

To run Apollo CLI against a local Sophia instance:

1. Start Sophia service (typically via Docker Compose)
2. Ensure Sophia is running on `localhost:8080` (or configure as needed)
3. Run Apollo CLI commands

Example with custom config:
```bash
apollo-cli --config my-config.yaml status
```

## Future Enhancements

This prototype provides the foundation for:
- Streaming responses for long-running operations
- WebSocket support for real-time updates
- Authentication and authorization
- Command history and caching
- Interactive command mode
- Web dashboard integration

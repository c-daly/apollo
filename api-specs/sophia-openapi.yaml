openapi: 3.0.3
info:
  title: Sophia Cognitive Core API
  description: |
    REST API for Sophia, the non-linguistic cognitive core of Project LOGOS.
    Provides planning, state management, and execution capabilities.
  version: 0.2.0
  contact:
    name: Project LOGOS Team

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: http://sophia:8080
    description: Docker compose service

tags:
  - name: Health
    description: Service health and status
  - name: State
    description: Agent state management
  - name: Goals
    description: Goal creation and management
  - name: Planning
    description: Plan generation and management
  - name: Execution
    description: Plan execution
  - name: Simulation
    description: Plan simulation and validation
  - name: Ingestion
    description: LLM proposal ingestion from Hermes

paths:
  /health:
    get:
      summary: Health check
      description: Check if Sophia service is running and healthy
      operationId: getHealth
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/state:
    get:
      summary: Get current agent state
      description: Retrieve the current state of the agent including beliefs, goals, and HCG graph data
      operationId: getState
      tags:
        - State
      responses:
        '200':
          description: Current agent state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/goals:
    post:
      summary: Create a new goal
      description: Create a new goal for the agent to pursue
      operationId: createGoal
      tags:
        - Goals
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGoalRequest'
      responses:
        '200':
          description: Goal created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GoalResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/plans:
    get:
      summary: Get plans
      description: Retrieve recent plans generated by the agent
      operationId: getPlans
      tags:
        - Planning
      parameters:
        - name: limit
          in: query
          description: Maximum number of plans to return
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of plans
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlansResponse'

  /api/plan:
    post:
      summary: Generate a plan
      description: Generate an execution plan for a goal
      operationId: createPlan
      tags:
        - Planning
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlanRequest'
      responses:
        '200':
          description: Plan generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/planner/invoke:
    post:
      summary: Invoke planner (legacy)
      description: Legacy endpoint to invoke planner for a goal
      operationId: invokePlanner
      tags:
        - Planning
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InvokePlannerRequest'
      responses:
        '200':
          description: Plan generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'

  /api/simulate:
    post:
      summary: Simulate plan execution
      description: Simulate plan execution without committing changes to verify outcomes
      operationId: simulatePlan
      tags:
        - Simulation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulatePlanRequest'
      responses:
        '200':
          description: Simulation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/executor/step:
    post:
      summary: Execute a plan step
      description: Execute a single step from a plan
      operationId: executeStep
      tags:
        - Execution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteStepRequest'
      responses:
        '200':
          description: Step executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/command:
    post:
      summary: Send command (legacy)
      description: Legacy endpoint to send natural language command
      operationId: sendCommand
      tags:
        - State
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendCommandRequest'
      responses:
        '200':
          description: Command processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'

  /ingest/hermes_proposal:
    post:
      summary: Ingest LLM proposal from Hermes
      description: |
        Accepts structured LLM proposals from Hermes including plans, imagined states,
        diagnostics, and tool calls. Persists to Neo4j with full provenance metadata
        and applies SHACL validation. Authentication disabled for local development.
      operationId: ingestHermesProposal
      tags:
        - Ingestion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HermesProposalRequest'
      responses:
        '201':
          description: Proposal successfully ingested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HermesProposalResponse'
        '422':
          description: Validation failed (SHACL or schema)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: HCG client not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          example: "ok"
        version:
          type: string
          example: "0.2.0"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details
          additionalProperties: true

    StateResponse:
      type: object
      properties:
        agent_id:
          type: string
          description: Agent identifier
        timestamp:
          type: string
          format: date-time
          description: State timestamp
        beliefs:
          type: object
          description: Agent beliefs
          additionalProperties: true
        goals:
          type: array
          description: Active goals
          items:
            $ref: '#/components/schemas/Goal'
        graph:
          $ref: '#/components/schemas/GraphData'

    Goal:
      type: object
      required:
        - id
        - description
      properties:
        id:
          type: string
          description: Goal identifier
        description:
          type: string
          description: Goal description
        status:
          type: string
          enum: [pending, active, completed, failed]
        priority:
          type: string
          enum: [low, normal, high]
        created_at:
          type: string
          format: date-time
        metadata:
          type: object
          additionalProperties: true

    GraphData:
      type: object
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/GraphNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/GraphEdge'

    GraphNode:
      type: object
      required:
        - id
        - type
      properties:
        id:
          type: string
        type:
          type: string
        label:
          type: string
        properties:
          type: object
          additionalProperties: true

    GraphEdge:
      type: object
      required:
        - source
        - target
        - type
      properties:
        source:
          type: string
        target:
          type: string
        type:
          type: string
        properties:
          type: object
          additionalProperties: true

    CreateGoalRequest:
      type: object
      required:
        - goal
      properties:
        goal:
          type: string
          description: Goal description
        metadata:
          type: object
          description: Optional metadata
          additionalProperties: true

    GoalResponse:
      type: object
      properties:
        goal_id:
          type: string
          description: Created goal ID
        goal:
          $ref: '#/components/schemas/Goal'

    PlansResponse:
      type: object
      properties:
        plans:
          type: array
          items:
            $ref: '#/components/schemas/Plan'

    Plan:
      type: object
      required:
        - id
        - goal_id
      properties:
        id:
          type: string
          description: Plan identifier
        goal_id:
          type: string
          description: Associated goal ID
        status:
          type: string
          enum: [pending, in_progress, completed, failed]
        steps:
          type: array
          items:
            $ref: '#/components/schemas/PlanStep'
        estimated_duration:
          type: integer
          description: Estimated duration in seconds
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        created_at:
          type: string
          format: date-time

    PlanStep:
      type: object
      required:
        - index
        - action
      properties:
        index:
          type: integer
          description: Step index
        action:
          type: string
          description: Action to perform
        parameters:
          type: object
          description: Action parameters
          additionalProperties: true
        expected_duration:
          type: integer
          description: Expected duration in seconds
        status:
          type: string
          enum: [pending, in_progress, completed, failed]

    CreatePlanRequest:
      type: object
      required:
        - goal_id
      properties:
        goal_id:
          type: string
          description: Goal ID to plan for
        context:
          type: object
          description: Additional context
          additionalProperties: true
        constraints:
          type: array
          description: Planning constraints
          items:
            type: string

    InvokePlannerRequest:
      type: object
      required:
        - goal_id
      properties:
        goal_id:
          type: string
          description: Goal ID to plan for

    PlanResponse:
      type: object
      properties:
        plan_id:
          type: string
          description: Generated plan ID
        plan:
          $ref: '#/components/schemas/Plan'

    SimulatePlanRequest:
      type: object
      required:
        - plan_id
      properties:
        plan_id:
          type: string
          description: Plan ID to simulate
        initial_state:
          type: object
          description: Initial state for simulation
          additionalProperties: true

    SimulationResponse:
      type: object
      properties:
        simulation_id:
          type: string
          description: Simulation identifier
        predicted_outcome:
          type: object
          description: Predicted outcome
          additionalProperties: true
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        issues:
          type: array
          description: Potential issues identified
          items:
            type: string
        duration_ms:
          type: integer
          description: Simulation duration in milliseconds

    ExecuteStepRequest:
      type: object
      required:
        - plan_id
        - step_index
      properties:
        plan_id:
          type: string
          description: Plan ID
        step_index:
          type: integer
          description: Step index to execute

    ExecutionResponse:
      type: object
      properties:
        execution_id:
          type: string
          description: Execution identifier
        status:
          type: string
          enum: [success, failure]
        result:
          type: object
          description: Execution result
          additionalProperties: true
        duration_ms:
          type: integer
          description: Execution duration in milliseconds

    SendCommandRequest:
      type: object
      required:
        - command
      properties:
        command:
          type: string
          description: Natural language command

    CommandResponse:
      type: object
      properties:
        message:
          type: string
          description: Response message
        data:
          type: object
          description: Response data
          additionalProperties: true

    HermesProposalRequest:
      type: object
      required:
        - proposal_id
        - llm_provider
        - model
        - generated_at
        - confidence
      properties:
        proposal_id:
          type: string
          description: Unique identifier for this proposal
          example: "hermes_20251123_abc123"
        source_service:
          type: string
          description: Source service (typically 'hermes')
          default: hermes
        llm_provider:
          type: string
          description: LLM provider name
          example: openai
          enum: [openai, anthropic, azure, google, local]
        model:
          type: string
          description: Model identifier
          example: gpt-4
        generated_at:
          type: string
          format: date-time
          description: ISO timestamp when proposal was generated
          example: "2025-11-23T12:00:00Z"
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Confidence score for this proposal
          example: 0.85
        raw_text:
          type: string
          description: Raw LLM response text
        plan_steps:
          type: array
          description: Structured plan steps from the LLM
          items:
            type: object
            properties:
              action:
                type: string
              target:
                type: string
              parameters:
                type: object
                additionalProperties: true
            additionalProperties: true
        imagined_states:
          type: array
          description: Imagined future states from the LLM
          items:
            type: object
            properties:
              state_id:
                type: string
              entities:
                type: object
                additionalProperties: true
            additionalProperties: true
        diagnostics:
          type: object
          description: Diagnostic information from the LLM
          additionalProperties: true
        tool_calls:
          type: array
          description: Tool calls requested by the LLM
          items:
            type: object
            properties:
              tool:
                type: string
              parameters:
                type: object
                additionalProperties: true
            additionalProperties: true
        metadata:
          type: object
          description: Additional metadata for provenance tracking
          additionalProperties: true

    HermesProposalResponse:
      type: object
      required:
        - proposal_id
        - stored_node_ids
        - status
        - created_at
      properties:
        proposal_id:
          type: string
          description: The ingested proposal identifier
        stored_node_ids:
          type: array
          description: Node IDs created in Neo4j for this proposal
          items:
            type: string
        status:
          type: string
          description: Ingestion status
          example: accepted
          enum: [accepted, rejected, partial]
        created_at:
          type: string
          format: date-time
          description: ISO timestamp of ingestion
        validation_results:
          type: object
          description: SHACL validation results if applicable
          additionalProperties: true

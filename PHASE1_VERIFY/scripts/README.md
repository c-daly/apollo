# PHASE1_VERIFY Scripts

This directory contains verification scripts for Phase 1 of the Apollo implementation, focusing on E2E testing of the Apollo CLI integration with Sophia and HCG.

## Overview

These scripts verify that the Apollo CLI properly routes commands through the system instead of relying on direct database operations (Cypher queries). This ensures proper separation of concerns and validates the complete integration stack.

## Scripts

### M4 Test: End-to-End Phase 1 Loop

**Script**: `m4_test.py`

**Purpose**: Verifies the complete Phase 1 prototype flow: Goal → Plan → Execute → State loop through Apollo CLI.

**What it tests**:
1. Apollo CLI can connect to Sophia service
2. Goals can be created via `apollo-cli goal` command
3. Initial state can be fetched via `apollo-cli state` command
4. Planner can be invoked via `apollo-cli plan` command
5. Plan steps can be executed via `apollo-cli execute` command
6. Final state can be fetched to verify changes
7. Goals are properly stored in Neo4j (optional verification)

**Prerequisites**:
- Apollo CLI installed: `pip install -e .`
- Sophia service running on `localhost:8080`
- Planner and executor stubs/shims available (or simulated)
- (Optional) Neo4j running on `bolt://localhost:7687` for verification

**Usage**:

```bash
# Run the M4 test
./PHASE1_VERIFY/scripts/m4_test.py

# Or with Python
python PHASE1_VERIFY/scripts/m4_test.py
```

**Expected Output**:
```
============================================================
        M4 E2E Test: Apollo CLI Phase 1 Loop
============================================================
ℹ Testing: Goal → Plan → Execute → State flow

============================================================
          Step 1: Check Sophia Connection
============================================================

Running: apollo-cli status
✓ Sophia service is accessible

============================================================
        Step 2: Create Goal via Apollo CLI
============================================================

Running: apollo-cli goal Navigate to the kitchen and pick up the red block --priority high
✓ Goal created: Navigate to the kitchen and pick up the red block

============================================================
        Step 3: Fetch State via Apollo CLI
============================================================

Running: apollo-cli state
✓ State fetched successfully

============================================================
        Step 4: Invoke Planner via Apollo CLI
============================================================

Running: apollo-cli plan test_goal_001
✓ Plan generated for goal: test_goal_001

============================================================
        Step 5: Execute Plan Step via Apollo CLI
============================================================

Running: apollo-cli execute test_goal_001 --step 0
✓ Step 0 executed for plan: test_goal_001

============================================================
       Step 6: Fetch State After Execution
============================================================

Running: apollo-cli state
✓ State fetched after execution

============================================================
         Step 7: Verify Goal in Neo4j
============================================================

✓ Goal found in Neo4j: Navigate to the kitchen and pick up the red block

============================================================
                M4 Test Result
============================================================

✓ All test steps completed successfully!
ℹ Phase 1 loop verified: Goal → Plan → Execute → State

✓ M4 E2E TEST PASSED
```

## Apollo CLI Commands

### Create a Goal

Create a new goal in the Sophia cognitive core:

```bash
apollo-cli goal "Navigate to the kitchen"
```

**With priority**:
```bash
apollo-cli goal "Pick up the red block" --priority high
```

**Options**:
- `--priority`: Set goal priority (`high`, `normal`, `low`). Default: `normal`

**Example output**:
```yaml
goal_id: "goal_123"
description: "Navigate to the kitchen"
status: "pending"
priority: "high"
created_at: "2025-11-19T14:00:00Z"
```

### Fetch Current State

Retrieve the current agent state from Sophia:

```bash
apollo-cli state
```

**Example output**:
```yaml
status: "active"
current_goal: "Navigate to the kitchen"
position:
  x: 10
  y: 5
  z: 0
timestamp: "2025-11-19T14:00:00Z"
```

### Send a Command

Send a natural language command to Sophia:

```bash
apollo-cli send "move forward 2 meters"
```

### Check Status

Display connection status and configuration:

```bash
apollo-cli status
```

### View Plans

Show recent plans generated by Sophia:

```bash
apollo-cli plans --recent 10
```

### Invoke Planner (Phase 1)

Invoke the planner to generate a plan for a specific goal:

```bash
apollo-cli plan "goal_12345"
```

**What it does**:
- Sends a request to Sophia's planner to generate a plan for the specified goal
- Returns plan details including plan ID, steps, and status
- The planner may be a stub/shim in Phase 1

**Example output**:
```yaml
plan_id: "plan_456"
goal_id: "goal_12345"
status: "ready"
steps:
  - action: "navigate"
    target: "kitchen"
  - action: "pick_up"
    target: "red_block"
created_at: "2025-11-19T14:00:00Z"
```

### Execute Plan Step (Phase 1)

Execute a single step from a plan (simulated execution in Phase 1):

```bash
apollo-cli execute "plan_456"
```

**With specific step index**:
```bash
apollo-cli execute "plan_456" --step 1
```

**Options**:
- `--step`: Step index to execute (default: 0 for first step)

**What it does**:
- Sends a request to Sophia's executor/Talos shim to execute one step
- Returns execution result and updated state
- The executor may be a stub/shim in Phase 1 (simulated execution)

**Example output**:
```yaml
execution_id: "exec_789"
plan_id: "plan_456"
step_index: 0
status: "completed"
result:
  action: "navigate"
  outcome: "success"
  new_position:
    x: 15
    y: 10
timestamp: "2025-11-19T14:01:00Z"
```

## API Endpoints

The Apollo CLI communicates with Sophia through these HTTP REST API endpoints:

### Create Goal
- **Endpoint**: `POST /api/goals`
- **Payload**: 
  ```json
  {
    "goal": "Navigate to the kitchen",
    "metadata": {
      "priority": "high"
    }
  }
  ```
- **Response**: Goal object with ID and status

### Get State
- **Endpoint**: `GET /api/state`
- **Response**: Current agent state object

### Send Command
- **Endpoint**: `POST /api/command`
- **Payload**: 
  ```json
  {
    "command": "move forward"
  }
  ```
- **Response**: Command execution result

### Get Plans
- **Endpoint**: `GET /api/plans?limit=10`
- **Response**: List of recent plans

### Invoke Planner (Phase 1)
- **Endpoint**: `POST /api/planner/invoke`
- **Payload**: 
  ```json
  {
    "goal_id": "goal_12345"
  }
  ```
- **Response**: Plan object with ID, steps, and status
- **Used by**: `apollo-cli plan` command

### Execute Plan Step (Phase 1)
- **Endpoint**: `POST /api/executor/step`
- **Payload**: 
  ```json
  {
    "plan_id": "plan_456",
    "step_index": 0
  }
  ```
- **Response**: Execution result with status and updated state
- **Used by**: `apollo-cli execute` command
- **Note**: In Phase 1, this may be a stub/shim that simulates execution

## Configuration

Apollo uses a configuration file to connect to services. Create a `config.yaml` in your working directory or use the default configuration:

```yaml
sophia:
  host: localhost
  port: 8080
  timeout: 30

hcg:
  neo4j:
    uri: bolt://localhost:7687
    user: neo4j
    password: password
  milvus:
    host: localhost
    port: 19530
```

You can also specify a custom config file:

```bash
apollo-cli --config path/to/config.yaml goal "Your goal"
```

## Running the Test Suite

To run all Apollo tests including the M4 E2E test:

```bash
# Run Python unit tests
pytest

# Run M4 E2E test
./PHASE1_VERIFY/scripts/m4_test.py
```

## Troubleshooting

### Connection Errors

If you see "Cannot connect to Sophia" errors:

1. Verify Sophia service is running:
   ```bash
   curl http://localhost:8080/health
   ```

2. Check your configuration:
   ```bash
   apollo-cli status
   ```

3. Ensure Docker containers are running (if using Docker):
   ```bash
   docker ps
   ```

### Goal Not Found in Neo4j

If the M4 test reports that a goal wasn't found in Neo4j:

1. This is expected if there's a delay in synchronization
2. The test will still pass with an informational message
3. You can manually verify by querying Neo4j:
   ```cypher
   MATCH (g:Goal) RETURN g
   ```

### Import Errors

If you see "neo4j driver not installed" warnings:

```bash
pip install neo4j
```

This is only needed for the Neo4j verification step and is optional.

## Architecture

The verification flow demonstrates the proper architecture:

```
M4 Test → Apollo CLI → HTTP API → Sophia Service → HCG (Neo4j)
```

This replaces the anti-pattern of:

```
Test → Direct Cypher → Neo4j (❌ bypasses Sophia)
```

## Related Documentation

- [Apollo README](../../README.md) - Main documentation
- [Prototype Wiring](../../docs/PROTOTYPE-WIRING.md) - Integration details
- [Contributing Guide](../../CONTRIBUTING.md) - Development guidelines

## Future Enhancements

Planned improvements for Phase 2:

- Additional E2E test scenarios
- Performance benchmarking scripts
- Integration test suite with mocked services
- Automated smoke tests for CI/CD pipeline
- Goal query and deletion commands
